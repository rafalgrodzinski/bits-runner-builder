@module DrvCmos

REGISTER_SELECT_PORT u32 <- 0x70
DATA_PORT u32 <- 0x71

REGISTER_B u32 <- 0x0b

REGISTER_SECONDS u32 <- 0x00
REGISTER_MINUTES u32 <- 0x02
REGISTER_HOURS u32 <- 0x04
REGISTER_DAY_OF_MONTH u32 <- 0x07
REGISTER_MONTH u32 <- 0x08
REGISTER_YEAR u32 <- 0x09

in raw<"=r,m,~{eax},~{edx}">: portNum u32 -> u8
    mov dx, $1
    in al, dx
    mov $0, al
;

out raw<"m,m,~{eax},~{edx}">: portNum u32, value u8
    mov dx, $0
    mov al, $1
    out dx, al
;

@export getTimestamp fun -> u32
    nmiFlag u32 <- in(REGISTER_SELECT_PORT) & 0x80

    out(REGISTER_SELECT_PORT, REGISTER_B | nmiFlag)
    state u32 <- in(DATA_PORT)
    isBcd bool <- state & 0x04 = 0
    is12Hour bool <- state & 0x02 = 0

    out(REGISTER_SELECT_PORT, REGISTER_SECONDS | nmiFlag)
    seconds u32 <- in(DATA_PORT)

    out(REGISTER_SELECT_PORT, REGISTER_MINUTES | nmiFlag)
    minutes u32 <- in(DATA_PORT)

    out(REGISTER_SELECT_PORT, REGISTER_HOURS | nmiFlag)
    hours u32 <- in(DATA_PORT)

    out(REGISTER_SELECT_PORT, REGISTER_DAY_OF_MONTH | nmiFlag)
    dayOfMonth u32 <- in(DATA_PORT)

    out(REGISTER_SELECT_PORT, REGISTER_MONTH | nmiFlag)
    month u32 <- in(DATA_PORT)

    out(REGISTER_SELECT_PORT, REGISTER_YEAR | nmiFlag)
    hours u32 <- in(DATA_PORT)
    rawHours u32 <- hours

    // handle bcd or binary mode
    if isBcd
        seconds <- (seconds & 0x0f) + ((seconds / 16) * 10)
        minutes <- (minutes & 0x0f) + ((minutes / 16) * 10)
        hours <- (hours & 0x0f) + ((hours / 16) * 10)
    ;

    // handle 12 or 24 hour clock
    if is24Hour and rawHours & 0x80 = 0x80
        hours <- ((hours & 0x7f) + 12) % 24
    ;

    timestamp u32 <- 0
    timestamp <- timestamp + seconds
    timestamp <- timestamp + minutes * 60
    timestamp <- timestamp + hours * 60 * 60

    ret timestamp
;